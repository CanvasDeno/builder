<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Page Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .canvas-element {
            padding: 8px;
            margin-bottom: 8px;
            border: 1px dashed #ccc;
            cursor: grab;
            transition: background-color 0.2s;
        }
        .canvas-element:hover {
            background-color: #f0f0f0;
            border-color: #aaa;
        }
        .canvas-element.selected {
            border: 2px solid #3b82f6; /* blue-500 */
            background-color: #e0e7ff; /* indigo-100 */
        }
        .placeholder {
            background-color: #e0e7ff;
            border: 2px dashed #9ca3af;
            height: 50px;
            margin-bottom: 8px;
        }
        #canvas-area:empty::before {
            content: "Drag or add elements here. Click an element to edit.";
            display: block;
            text-align: center;
            padding: 20px;
            color: #9ca3af; /* gray-400 */
            border: 2px dashed #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .element-add-btn, #exportCshtmlBtn, #saveChangesBtn, #deleteElementBtn, #cancelEditBtn {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            text-align: center;
        }
        .element-add-btn {
            background-color: #3b82f6; /* blue-500 */
            color: white;
        }
        .element-add-btn:hover {
            background-color: #2563eb; /* blue-600 */
        }
        #exportCshtmlBtn {
            background-color: #10b981; /* green-500 */
            color: white;
        }
        #exportCshtmlBtn:hover {
            background-color: #059669; /* green-600 */
        }
        #saveChangesBtn {
             background-color: #3b82f6; /* blue-500 */
             color: white;
        }
        #saveChangesBtn:hover {
            background-color: #2563eb; /* blue-600 */
        }
        #deleteElementBtn {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        #deleteElementBtn:hover {
            background-color: #dc2626; /* red-600 */
        }
         #cancelEditBtn {
            background-color: #6b7280; /* gray-500 */
            color: white;
        }
        #cancelEditBtn:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 500px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Dynamic Page Builder</h1>
            <h2 class="text-1xl md:text-4xl font-bold text-gray-800">ASPXone</h2>
            </header>

        <div class="flex flex-col lg:flex-row gap-6">
            <aside class="lg:w-1/4 bg-white p-6 rounded-lg shadow-xl order-1 lg:order-none">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Add Elements</h2>
                <div class="space-y-2">
                    <button data-type="heading" class="element-add-btn">Add Heading</button>
                    <button data-type="paragraph" class="element-add-btn">Add Paragraph</button>
                    <button data-type="link" class="element-add-btn">Add Link</button>
                    <button data-type="button" class="element-add-btn">Add Button</button>
                    <button data-type="image" class="element-add-btn">Add Image</button>
                </div>
                <hr class="my-6 border-gray-300">
                <button id="exportCshtmlBtn" class="w-full">
                    Export as .cshtml
                </button>
            </aside>

            <main class="lg:w-1/2 bg-white p-6 rounded-lg shadow-xl min-h-[400px] order-2 lg:order-none" id="canvas-area">
            </main>

            <aside class="lg:w-1/4 bg-white p-6 rounded-lg shadow-xl order-3 lg:order-none" id="editor-panel-container" style="display: none;">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Edit Element</h2>
                <form id="editor-form">
                    <div id="editor-form-content" class="space-y-4">
                    </div>
                    <div class="mt-6 space-y-2">
                        <button type="submit" id="saveChangesBtn">Save Changes</button>
                        <button type="button" id="deleteElementBtn">Delete Element</button>
                        <button type="button" id="cancelEditBtn">Cancel</button>
                    </div>
                </form>
            </aside>
        </div>
    </div>

    <div id="customAlertModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="customAlertClose">&times;</span>
            <p id="customAlertMessage" class="text-gray-700"></p>
            <div class="mt-4 text-right">
                <button id="customAlertOkBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">OK</button>
            </div>
        </div>
    </div>
    
    <script>
        // No Firebase imports needed

        let elements = [];
        let currentEditingId = null;
        let dragSrcElement = null;
        const LOCAL_STORAGE_KEY = 'dynamicPageBuilderElements';

        const canvasArea = document.getElementById('canvas-area');
        const editorPanelContainer = document.getElementById('editor-panel-container');
        const editorForm = document.getElementById('editor-form');
        const editorFormContent = document.getElementById('editor-form-content');
        
        const customAlertModal = document.getElementById('customAlertModal');
        const customAlertClose = document.getElementById('customAlertClose');
        const customAlertMessage = document.getElementById('customAlertMessage');
        const customAlertOkBtn = document.getElementById('customAlertOkBtn');

        function showCustomAlert(message) {
            customAlertMessage.textContent = message;
            customAlertModal.style.display = "block";
        }

        customAlertClose.onclick = function() {
            customAlertModal.style.display = "none";
        }
        customAlertOkBtn.onclick = function() {
            customAlertModal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == customAlertModal) {
                customAlertModal.style.display = "none";
            }
        }

        function loadPageContent() {
            const storedElements = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedElements) {
                try {
                    elements = JSON.parse(storedElements);
                    console.log("Elements loaded from localStorage:", elements);
                } catch (e) {
                    console.error("Error parsing elements from localStorage:", e);
                    elements = []; // Fallback to empty array on error
                    localStorage.removeItem(LOCAL_STORAGE_KEY); // Clear corrupted data
                }
            } else {
                elements = [];
                console.log("No existing page data in localStorage, starting fresh.");
            }
            renderCanvas();
        }

        function savePageContent() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(elements));
                console.log("Page content saved to localStorage.");
            } catch (e) {
                console.error("Error saving page content to localStorage:", e);
                showCustomAlert("Error saving data. Your browser's storage might be full or disabled.");
            }
        }

        function renderCanvas() {
            canvasArea.innerHTML = '';
            if (elements.length === 0) {
                 // CSS :empty pseudo-element handles the placeholder text
            } else {
                elements.forEach((element, index) => {
                    const elWrapper = document.createElement('div');
                    elWrapper.classList.add('canvas-element', 'p-2', 'my-2', 'border', 'rounded-md', 'cursor-pointer', 'relative');
                    elWrapper.dataset.id = element.id;
                    elWrapper.dataset.index = index; 
                    elWrapper.draggable = true; 

                    let elHtml = '';
                    switch (element.type) {
                        case 'heading':
                            elHtml = `<h${element.properties.level || 2} class="text-${element.properties.size || 'xl'} font-bold">${escapeHtml(element.properties.text || '')}</h${element.properties.level || 2}>`;
                            break;
                        case 'paragraph':
                            elHtml = `<p class="text-${element.properties.size || 'base'}">${escapeHtml(element.properties.text || '')}</p>`;
                            break;
                        case 'link':
                            elHtml = `<a href="${escapeHtml(element.properties.href || '#')}" target="_blank" class="text-blue-600 hover:underline text-${element.properties.size || 'base'}">${escapeHtml(element.properties.text || '')}</a>`;
                            break;
                        case 'button':
                            elHtml = `<button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">${escapeHtml(element.properties.text || '')}</button>`;
                            break;
                        case 'image':
                            elHtml = `<img src="${escapeHtml(element.properties.src || 'https://placehold.co/100x100/eee/ccc?text=Image')}" alt="${escapeHtml(element.properties.alt || '')}" class="max-w-full h-auto rounded-md" onerror="this.src='https://placehold.co/100x100/eee/ccc?text=Error'; this.onerror=null;">`;
                            break;
                    }
                    elWrapper.innerHTML = elHtml;
                    elWrapper.addEventListener('click', () => showEditor(element.id));
                    
                    elWrapper.addEventListener('dragstart', handleDragStart);
                    elWrapper.addEventListener('dragover', handleDragOver);
                    elWrapper.addEventListener('drop', handleDrop);
                    elWrapper.addEventListener('dragend', handleDragEnd);

                    canvasArea.appendChild(elWrapper);
                });
            }
        }

        function handleDragStart(e) {
            dragSrcElement = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML); 
            this.style.opacity = '0.4';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); 
            }
            e.dataTransfer.dropEffect = 'move';
            
            const targetElement = e.target.closest('.canvas-element');
            if (targetElement && targetElement !== dragSrcElement) {
                const rect = targetElement.getBoundingClientRect();
                const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > .5;
                
                document.querySelectorAll('.placeholder').forEach(p => p.remove());

                const placeholder = document.createElement('div');
                placeholder.className = 'placeholder';
                if (next) {
                    targetElement.parentNode.insertBefore(placeholder, targetElement.nextSibling);
                } else {
                    targetElement.parentNode.insertBefore(placeholder, targetElement);
                }
            }
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation(); 
            }
            if (dragSrcElement !== this) {
                const srcIndex = parseInt(dragSrcElement.dataset.index);
                let targetIndex = parseInt(this.dataset.index);

                const rect = this.getBoundingClientRect();
                const dropAfter = (e.clientY - rect.top) / (rect.bottom - rect.top) > .5;

                if (dropAfter) {
                    targetIndex = targetIndex + 1;
                }
                
                const movedElement = elements.splice(srcIndex, 1)[0];
                if (srcIndex < targetIndex) {
                    targetIndex--; 
                }
                elements.splice(targetIndex, 0, movedElement);
                
                savePageContent(); 
                renderCanvas(); // Re-render immediately after local change
            }
            document.querySelectorAll('.placeholder').forEach(p => p.remove());
            return false;
        }
        
        function handleDragEnd(e) {
            this.style.opacity = '1';
            document.querySelectorAll('.placeholder').forEach(p => p.remove());
            renderCanvas(); // Ensure clean state
        }

        function generateUniqueId() {
            return crypto.randomUUID();
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        document.querySelectorAll('.element-add-btn').forEach(button => {
            button.addEventListener('click', () => {
                const type = button.dataset.type;
                addElement(type);
            });
        });

        function addElement(type) {
            const newElement = {
                id: generateUniqueId(),
                type: type,
                properties: {}
            };

            switch (type) {
                case 'heading':
                    newElement.properties = { text: 'New Heading', level: 2, size: '2xl' };
                    break;
                case 'paragraph':
                    newElement.properties = { text: 'New paragraph text.', size: 'base' };
                    break;
                case 'link':
                    newElement.properties = { text: 'New Link', href: '#', size: 'base' };
                    break;
                case 'button':
                    newElement.properties = { text: 'Click Me' };
                    break;
                case 'image':
                    newElement.properties = { src: 'https://placehold.co/300x200/e2e8f0/94a3b8?text=New+Image', alt: 'New Image' };
                    break;
            }
            elements.push(newElement);
            savePageContent();
            renderCanvas();
            showCustomAlert(`${type.charAt(0).toUpperCase() + type.slice(1)} added.`);
            showEditor(newElement.id); 
        }

        function showEditor(elementId) {
            currentEditingId = elementId;
            const element = elements.find(el => el.id === elementId);
            if (!element) {
                hideEditor();
                return;
            }

            document.querySelectorAll('.canvas-element').forEach(el => el.classList.remove('selected'));
            const canvasEl = canvasArea.querySelector(`.canvas-element[data-id="${elementId}"]`);
            if (canvasEl) canvasEl.classList.add('selected');

            editorFormContent.innerHTML = ''; 

            if (element.properties.hasOwnProperty('text')) {
                editorFormContent.appendChild(createFormInput('text', 'Text', element.properties.text, 'text'));
            }

            switch (element.type) {
                case 'heading':
                    editorFormContent.appendChild(createFormSelect('level', 'Level', element.properties.level, [
                        { value: 1, text: 'H1' }, { value: 2, text: 'H2' }, { value: 3, text: 'H3' },
                        { value: 4, text: 'H4' }, { value: 5, text: 'H5' }, { value: 6, text: 'H6' }
                    ]));
                    editorFormContent.appendChild(createFormSelect('size', 'Size (approx)', element.properties.size, [
                        {value: 'sm', text: 'Small'}, {value: 'base', text: 'Base'}, {value: 'lg', text: 'Large'},
                        {value: 'xl', text: 'XL'}, {value: '2xl', text: '2XL'}, {value: '3xl', text: '3XL'}, {value: '4xl', text: '4XL'}
                    ]));
                    break;
                case 'paragraph':
                     editorFormContent.appendChild(createFormSelect('size', 'Size (approx)', element.properties.size, [
                        {value: 'xs', text: 'Extra Small'}, {value: 'sm', text: 'Small'}, {value: 'base', text: 'Base'}, 
                        {value: 'lg', text: 'Large'}, {value: 'xl', text: 'XL'}
                    ]));
                    const textInput = editorFormContent.querySelector('input[data-property="text"]');
                    if(textInput && element.properties.hasOwnProperty('text')) { // Check if text property exists
                        const newTextArea = document.createElement('textarea');
                        newTextArea.id = 'property-text';
                        newTextArea.dataset.property = 'text';
                        newTextArea.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 h-24';
                        newTextArea.value = element.properties.text;
                        textInput.parentNode.replaceChild(newTextArea, textInput);
                    }
                    break;
                case 'link':
                    editorFormContent.appendChild(createFormInput('href', 'URL (href)', element.properties.href, 'url'));
                     editorFormContent.appendChild(createFormSelect('size', 'Size (approx)', element.properties.size, [
                        {value: 'sm', text: 'Small'}, {value: 'base', text: 'Base'}, {value: 'lg', text: 'Large'},
                        {value: 'xl', text: 'XL'}
                    ]));
                    break;
                case 'image':
                    editorFormContent.appendChild(createFormInput('src', 'Image URL (src)', element.properties.src, 'url'));
                    editorFormContent.appendChild(createFormInput('alt', 'Alt Text', element.properties.alt, 'text'));
                    break;
            }
            editorPanelContainer.style.display = 'block';
        }
        
        function createFormInput(property, labelText, value, type = 'text') {
            const div = document.createElement('div');
            const label = document.createElement('label');
            label.htmlFor = `property-${property}`;
            label.className = 'block text-sm font-medium text-gray-700';
            label.textContent = labelText;
            const input = document.createElement('input');
            input.type = type;
            input.id = `property-${property}`;
            input.dataset.property = property;
            input.value = value;
            input.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2';
            if (type === 'url') input.placeholder = 'https://example.com';
            div.appendChild(label);
            div.appendChild(input);
            return div;
        }

        function createFormSelect(property, labelText, value, options) {
            const div = document.createElement('div');
            const label = document.createElement('label');
            label.htmlFor = `property-${property}`;
            label.className = 'block text-sm font-medium text-gray-700';
            label.textContent = labelText;
            const select = document.createElement('select');
            select.id = `property-${property}`;
            select.dataset.property = property;
            select.className = 'mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2';
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                if (String(opt.value) == String(value)) option.selected = true;
                select.appendChild(option);
            });
            div.appendChild(label);
            div.appendChild(select);
            return div;
        }

        function hideEditor() {
            editorPanelContainer.style.display = 'none';
            currentEditingId = null;
            if (editorForm) editorForm.reset(); // Check if editorForm exists
            document.querySelectorAll('.canvas-element.selected').forEach(el => el.classList.remove('selected'));
        }

        if (editorForm) { // Ensure editorForm exists before adding listener
            editorForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!currentEditingId) return;

                const elementIndex = elements.findIndex(el => el.id === currentEditingId);
                if (elementIndex === -1) return;

                const updatedProperties = { ...elements[elementIndex].properties };
                editorFormContent.querySelectorAll('[data-property]').forEach(input => {
                    updatedProperties[input.dataset.property] = input.value;
                });
                
                elements[elementIndex].properties = updatedProperties;
                savePageContent();
                renderCanvas();
                showCustomAlert("Element updated.");
            });
        }

        const deleteBtn = document.getElementById('deleteElementBtn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
                if (!currentEditingId) return;
                elements = elements.filter(el => el.id !== currentEditingId);
                savePageContent();
                renderCanvas();
                showCustomAlert("Element deleted.");
                hideEditor();
            });
        }
        
        const cancelBtn = document.getElementById('cancelEditBtn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                hideEditor();
            });
        }

        const exportBtn = document.getElementById('exportCshtmlBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                let cshtmlContent = '@page\n'; 
                cshtmlContent += '@* Generated by Dynamic Page Builder *@@\n\n';

                elements.forEach(element => {
                    switch (element.type) {
                        case 'heading':
                            cshtmlContent += `<h${element.properties.level || 2} class="text-${element.properties.size || 'xl'} font-bold">${escapeHtml(element.properties.text || '')}</h${element.properties.level || 2}>\n`;
                            break;
                        case 'paragraph':
                            cshtmlContent += `<p class="text-${element.properties.size || 'base'}">${escapeHtml(element.properties.text || '')}</p>\n`;
                            break;
                        case 'link':
                            cshtmlContent += `<a href="${escapeHtml(element.properties.href || '#')}" target="_blank" class="text-blue-600 hover:underline text-${element.properties.size || 'base'}">${escapeHtml(element.properties.text || '')}</a>\n`;
                            break;
                        case 'button':
                            cshtmlContent += `<button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">${escapeHtml(element.properties.text || '')}</button>\n`;
                            break;
                        case 'image':
                            cshtmlContent += `<img src="${escapeHtml(element.properties.src || '')}" alt="${escapeHtml(element.properties.alt || '')}" class="max-w-full h-auto rounded-md" />\n`;
                            break;
                    }
                });

                const blob = new Blob([cshtmlContent], { type: 'application/octet-stream' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'generatedPage.cshtml';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                showCustomAlert("Page exported as .cshtml file.");
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPageContent();
        });

    </script>
</body>
</html>
